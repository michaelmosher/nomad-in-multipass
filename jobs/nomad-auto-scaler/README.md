# Nomad Auto-scaler

This example demonstrates how to deploy the Nomad Auto-scaler and how to use it
to horizontally-scale the Nomad cluster it's run on.

Because this repo is dedicated to running a Nomad cluster using Multipass and
because Multipass isn't a
[target supported by the Auto-scaler out-of-the-box](https://developer.hashicorp.com/nomad/tools/autoscaling/plugins/target),
this example installs and configures a
[custom plugin](https://github.com/michaelmosher/nomad-plugin-multipass-target)
to interface with the Multipass daemon.

## Setup

- Multipass

    By default, the Multipass daemon binds to a local Unix socket (eg.
    `/var/run/multipass_socket` on MacOS) and the `multipass` CLI interacts with
    it by sending RPC commands there. In order for a process running within a
    Multipass VM to interact with the Multipass daemon, we need to change this.

    Because we will be making the daemon remote-accessible, we should begin by
    setting a non-empty passphrase for clients to use when authenticating:

    ```shell
    multipass set local.passphrase
    ```

    More information can be found [here](https://multipass.run/docs/passphrase).

    Then, we can reconfigure the daemon to bind to a network address, rather
    than a local socket, by providing the `--address <server_name:port>`
    argument when it is launched.
    
    More information can be found [here](https://multipass.run/docs/how-to-use-multipass-remotely-a-preview).

    **Note**: After making this change, we will also need to configure the
    `MULTIPASS_SERVER_ADDRESS` environment variable in order for the `multipass`
    command to use the new address:

    ```shell
    export MULTIPASS_SERVER_ADDRESS=<my private IP>:50051
    ```

- Nomad

    Before this job can be properly launched, we much create a Nomad Variable
    containing a x509 key-pair (used by the multipass client to establish a TLS
    connection) and the Multipass passphrase we set in the previous section.

    While any x509 key and certificate from a trusted authority can be used, for
    convenience, I've used a pair generated by Multipass itself.
    
    The output from `create_nomad_variable_input.sh` can be piped to
    `nomad var put` to create the Variable with the TLS key-pair.

    Additional notes:

    - Depending on the file permissions of the Multipass certificates, the
        script may need to be invoked as a privileged user.
    - The Variable will also need the Multipass passphrase. This can either be
        provided at initial creation as an additonal argument to the
        `nomad var put` command or as a subsequent step (using the UI, for
        example).
    - The `nomad` wrapper script at the root of this repo can be used to
        simplify targeting the cluster running within Multipass.

    Taken together, one command that achieves the expect result would be:

    ```shell
    sudo jobs/nomad-auto-scaler/create_nomad_variable_input.sh \
    | ./nomad var put -in json nomad/jobs/nomad-auto-scaler - \
        passphrase=<my multipass passphrase>
    ```

## Execution

After setup is complete, the job can be run in the expected way:

```shell
./nomad job run nomad/jobs/nomad-auto-scaler/auto-scaler.nomad
```

If the `auto-scaler` service and the `multipass-target` plugin are both
operating successfully, a new client should be automatically launched due to
`min = 2` in the provided scaling policy.
